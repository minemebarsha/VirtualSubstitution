\section{Solving Non-linear Equalities with Virtual Substitution}
\label{sec:solving non-linear equalities with virtual substitution}
Virtual Substitution is a restricted but very efficient procedure to solve non-linear equalities. In the paper [1] author explored an extension of the ideas in [2] from the linear to the quadratic case. For linear case the idea was to eliminate a quantifier from $\exists x \varphi$ by replacing $x$ in $\varphi$ with $t$ that may involve improper expressions such as $\pm \infty$ or $\epsilon$. However, $\varphi [t\backslash\backslash x]$ is defined in such a way that these improper expressions do not occur in the resulting formula.

Author extended these idea to various quadratic cases. The cases are the substitution of square root expressions and the substitution of infinitesimal expressions in formulas.

In virtual substitution, first a variable is replaced by test candidate and to perform the replacement we need to construct test candidates. An univariate real-arithmetic formula is satisfiable if and only if there is one test candidate for which satisfies formula and the side conditions of t holds. For multivariate real-arithmetic formula the virtual substitution method continues with the elimination of the next variable.

In this section we will see how we can apply virtual substitution. Let us consider a multivariate real-arithmetic formula which we will use in this section,
$$ \varphi = \underbrace{(x^{2}y + x + y = 0)}\limits_{p_{1}} \wedge \underbrace{(y^{2} -2 < 0)}\limits_{p_{2}}$$
\subsection{Constructing test candidates with side condition}
First we will eliminate $x$ from $\varphi$. To construct the test candidates for x, we have to compute SqrtEx for $x$. Also we need to consider an infinitesimal $\epsilon$.
\begin{mdframed}[hidealllines=true,backgroundcolor=blue!20,innerleftmargin=3pt,innerrightmargin=3pt,leftmargin=-3pt,rightmargin=-3pt]
	\begin{definition}[Construction of Test Candidates]
		\label{def:construction_of_test_candidates}
		The set of all test candidates is defined by,
		$$ TCS := SqrtEx \cup \{t+\epsilon \text{ } \lvert  \text{ }t\in SqrtEx\} $$
		The set of test candidates for $x$ in $p(x) = ax^{2} + bx + c \sim 0$ is defined by,
		$$
		(x, p(x)\sim 0)
		\quad \mapsto \quad 
		\left\{
		\begin{array}{ll}
		{\displaystyle \{-\infty,\frac{-c}{b},\frac{-b \pm \sqrt{b^{2}-4ac}}{2a}\}} 
		& 
		\text{, if }\sim \text{ is weak }
		\\[0.6cm] % adjust the line spacing
		{\displaystyle \{-\infty,\frac{-c}{b} + \epsilon,\frac{-b \pm \sqrt{b^{2}-4ac}}{2a}+\epsilon\}}
		& 
		\text{, otherwise }
		\end{array}
		\right.$$
		where $a, b, c \in P$, $x\notin a\cup b\cup c $ and weak means $\{=,\leq,\geq\}$
		
		The side condition of a test candidate is defined by,
		$$
		C_t: t
		\quad \mapsto \quad 
		\left\{
		\begin{array}{lll}
		{\displaystyle C_{t^{\prime}}}
		& 
		\text{, if } t = t^{\prime} + \epsilon
		\\[0.6cm] % adjust the line spacing
		{\displaystyle \{s\neq 0 \wedge r\geq 0\}}
		& 
		\text{, if } t = \frac{p+q\sqrt{r}}{s}
		\\[0.6cm] % adjust the line spacing
		{\displaystyle true}
		& 
		\text{, Otherwise }
		\end{array}
		\right.$$
		where $p, q, r$ and $s$ are polynomials and $t^{\prime}$ is a test candidate where $\epsilon \notin t^{\prime}$.
	\end{definition}
\end{mdframed}

Each side condition of the test candidates confirms that each test candidate exists. The side condition of the test candidate $-\infty$ is valid because, it does not relate to a zero.

To eliminate $x$ first we get the following test candidates,
\begin{alignat}{2}
	&x_{0} = -y\qquad                            
	&& \text{, if $ y = 0 \wedge 1\neq 0$} \\
	&x_{1} = \frac{-1 + \sqrt{1^{2}-4y^{2}}}{2y}\qquad      
	&& \text{, if $ y \neq 0 \wedge 1^{2}-4y^{2}\geq 0$} \\
	&x_{2} = \frac{-1 - \sqrt{1^{2}-4y^{2}}}{2y}\qquad      
	&& \text{, if $ y \neq 0 \wedge 1^{2}-4y^{2}\geq 0$} \\
	&x_{3} = -\infty\qquad      
	&& \text{, if $ y = 0 \wedge 1 = 0$}
\end{alignat}
Here, $C_{x_{3}}$ is invalid. So, $x_{3}$ does not exist for $p_{1}$.

Now, we will put all the test candidates of $x$ in $\varphi$ and we will get following three quantifier free and $x$ free real-arithmetic formulas,
\begin{alignat}{2}
	&\varphi_{1} = \varphi [x_{0}\backslash\backslash x] = (y^{3} + 2y = 0) \wedge (y^{2} - 2 < 0) \wedge (y = 0) \wedge (1 \neq 0) \qquad      
	 \\
	&\varphi_{2} = \varphi [x_{1}\backslash\backslash x] = (p_{3} = 0) \wedge (y^{2} - 2 < 0) \wedge (y \neq 0) \wedge (1-4y^{2}\geq 0) \qquad      
	 \\
	&\varphi_{3} = \varphi [x_{2}\backslash\backslash x] = (p_{4} = 0) \wedge (y^{2} - 2 < 0) \wedge (y \neq 0) \wedge (1-4y^{2}\geq 0) \qquad      
	&&
\end{alignat}
where, 
$$p_{3} = (\underbrace{(\frac{-1 + \sqrt{1-4y^{2}}}{2y})^{2}y+(\frac{-1 + \sqrt{1-4y^{2}}}{2y})+y}\limits_{\text{it will be always 0 as it is a real zero}} = 0 )$$ 
and 
$$p_{4} = (\underbrace{(\frac{-1 - \sqrt{1-4y^{2}}}{2y})^{2}y+(\frac{-1 - \sqrt{1-4y^{2}}}{2y})+y}\limits_{\text{it will be always 0 as it is a real zero}} = 0 )$$


% Please add the following required packages to your document preamble:
% \usepackage{multirow}
\begin{table}[]
	\centering
	\caption{Test Candidates for $y$ with side conditions}
	\label{my-label}
	\begin{tabular}{|c|c|c|c|}
		\hline
		& Test Candidate & Side Condition & \begin{tabular}[c]{@{}c@{}}Validation\\ of\\ Side Condition\end{tabular} \\ \hline
		\multirow{3}{*}{$\varphi_{1}$,$\varphi_{2}$,$\varphi_{3}$} & $\sqrt{2}+\epsilon$ & $1\neq 0 \wedge 8 \geq 0$ & \checkmark \\ \cline{2-4} 
		& $-\sqrt{2}+\epsilon$ & $1\neq 0 \wedge 8 \geq 0$ & \checkmark \\ \cline{2-4} 
		& $-\infty$ & true & \checkmark \\ \hline
		$\varphi_{1}$& $0$ & $0 = 0 \wedge 1 \neq 0 $ & \checkmark \\ \hline
		\multirow{5}{*}{$\varphi_{2}$,$\varphi_{3}$} & $2+\epsilon$ & $1=0 \wedge 0\neq 0$ & \textbf{x} \\ \cline{2-4} 
		& $0+\epsilon$ & $0\neq 0 \wedge -2\neq 0$ & \textbf{x} \\ \cline{2-4} 
		& $\frac{1}{2}$ & $-4\neq 0 \wedge 16\geq 0$ & \checkmark \\ \cline{2-4} 
		& $-\frac{1}{2}$ & $-4\neq 0 \wedge 16\geq 0$ & \checkmark \\ \cline{2-4}
		& $\frac{-1}{0}\}\text{invalid value}$ & - & - \\ \hline
	\end{tabular}
\end{table}
To eliminate $y$ from $\varphi_{1}$,$\varphi_{2}$,$\varphi_{3}$ we construct the test candidates for $y$ given in Table 3.1 where we marked the valid and invalid side conditions.
\subsection{Substitute Variables by Test Candidates Virtually}
We have already seen the construction of test candidates for a given multivariate real-arithmetic formula $\varphi $. $\varphi $ is satisfiable if and only if one of the test candidates is a solution of $\varphi $. If all test candidates satisfy $\varphi $, it is said to be valid.

We eliminated $x$ already and currently we have $\varphi_{1},\varphi_{2}$ and $\varphi_{3}$ from which $y$ is needed to be eliminate. In $\varphi_{1}$, there is a constraint $y^{3}+2y = 0$ which has a degree of 3. We will not consider this constraint for substitution as the degree is higher than 2. If the constructed test candidates of $y$ from the other constrains in $\varphi_{1}$ satisfy this constraint, $\varphi $ is satisfiable. $\varphi_{2}$ and $\varphi_{3}$ have become same as $p_{3}$ and $p_{4}$ are already satisfied. Further, we will represent $\varphi_{2}$ and $\varphi_{3}$ as $\varphi_{4}$.
$$\varphi_{4} = (y^{2} - 2 < 0) \wedge (y \neq 0) \wedge (1-4y^{2}\geq 0) $$

In this section, we will eliminate $y$ by substituting the test candidates and check if the formula is satisfiable. To perform substitution the major substitution rules are described in the following.
\subsubsection{Substitution of Square Root Expressions}
Let, t is a test candidate for $x$ where $t = \frac{p_{1}+q_{1}\sqrt{r}}{s_{1}}$ is a square root expression. Let consider a constraint $p=0$ and we want to substitute $t$ for $x$ in it. If we substitute $t$ for all occurrences of $x$ in $p$, we can transform the result into $\frac{p_{2}+q_{2}\sqrt{r}}{s_{2}}$ which is also a square root expression where $p_{2}, q_{2}$ and $s_{2}\in P$. It has to be mentioned that, the radicand still remains the same which is $r$.
This transformation is possible as the summation and multiplication result of two square root expression with the same radicand is a square root expression of that radicand.
\begin{itemize}
	\item Summation,
	$$ \frac{p_{3}+q_{3}\sqrt{r}}{s_{3}}+\frac{p_{4}+q_{4}\sqrt{r}}{s_{4}} = \frac{s_{4}(p_{3}+q_{3}\sqrt{r})+s_{3}(p_{4}+q_{4}\sqrt{r})}{s_{3}s_{4}} = \frac{s_{4}p_{3}+s_{4}q_{3}\sqrt{r}+s_{3}p_{4}+s_{3}q_{4}\sqrt{r}}{s_{3}s_{4}}$$
	$$ =\frac{\overbrace{s_{4}p_{3}+s_{3}p_{4}}\limits^{p_{2}}+(\overbrace{s_{4}q_{3}+s_{3}q_{4}}\limits^{q_{2}})\sqrt{r}}{\underbrace{s_{3}s_{4}}\limits_{s_{2}}}$$
	\item Multiplication,
	$$ \frac{p_{3}+q_{3}\sqrt{r}}{s_{3}}*\frac{p_{4}+q_{4}\sqrt{r}}{s_{4}} =
	\frac{(p_{3}+q_{3}\sqrt{r})(p_{4}+q_{4}\sqrt{r})}{s_{3}s_{4}} =
	\frac{p_{3}p_{4}+p_{3}q_{4}\sqrt{r}+p_{4}q_{3}\sqrt{r}+q_{3}\sqrt{r}q_{4}\sqrt{r}}{s_{3}s_{4}}$$
	$$
	=\frac{\overbrace{p_{3}p_{4}}\limits^{p_{2}}+(\overbrace{p_{3}q_{4}+p_{4}q_{3}+q_{3}q_{4}}\limits^{q_{2}})\sqrt{r}}{\underbrace{s_{3}s_{4}}\limits_{s_{2}}}$$
\end{itemize}

The equation $\frac{p_{2}+q_{2}\sqrt{r}}{s_{2}} = 0$ holds if and only if $p_{2}+q_{2}\sqrt{r} = 0$. It holds if and only if either $(p_{2} = 0\wedge q_{2} = 0)$ or $p_{2}$ and $q_{2}$ have different signs with same absolute value, i.e., $|p_{2}|=|q_{2}\sqrt{r}|$. So, after substitution, we get the following quantifier free real arithmetic formula,
$$ (p = 0)[t\backslash\backslash x] = (p_{2}q_{2}\leq 0) \wedge (p_{2}^{2} - q_{2}^{2} r = 0) $$
\subsubsection{Substitution of Infinitesimal Expressions}
Let, $t+\epsilon$ is a test candidate for $x$ where $t\neq - \infty$ and $\epsilon \notin t$. Let consider a constraint $p<0$ and we want to substitute $t$ for $x$ in it. Note that $x$ should be occurred at most quadratic in $p$. After substitution we will get the following quantifier-free real-arithmetic formula,
$$(p<0)[t+\epsilon\backslash\backslash x]=\underbrace{((p<0)[t\backslash\backslash x])}\limits_{\text{Case 1}} \text{ }\vee\text{ }\underbrace{((p=0)[t\backslash\backslash x]\wedge(p^{\prime}<0)[t\backslash\backslash x])}\limits_{\text{Case 2}}\text{ }\vee$$
$$\underbrace{((p=0)[t\backslash\backslash x]\wedge(p^{\prime}=0)[t\backslash\backslash x]\wedge (p^{\prime\prime}<0[t\backslash\backslash x])}\limits_{\text{Case 3}} $$
where $p^{\prime}$ and $p^{\prime\prime}$ are the fist and second derivative of $p$ for $x$, respectively. $(p<0)[t+\epsilon\backslash\backslash x]$ holds if and only if any of the three cases hold for $x=t$
\begin{itemize}
	\item Case 1 states that if we substitute $t$ for all $x$ in $p<0$ and it holds, there must be a value in the right of $t$. It means if $x$ has this value, after substitution in $p$, it will still evaluate to a negative value.
	\item Case 2 states that if we substitute $t$ for all $x$ in $p$, it will evaluate to a zero. Also if we move to the right of $t$, $p$ will decrease only when $(p^{\prime}<0)[t\backslash\backslash x]$. So, there must be a value in the right of $t$ so that $p$ will evaluate to a negative value
	\item In case 3 $p<0[t\backslash\backslash x]$ holds if and only if for $x = t$ $p$, $p^{\prime}$ are equal to $0$, but $p^{\prime\prime}$ evaluates to $0$. It means, there must be a value from $t$ to positive $x$-direction for which $p<0$.
\end{itemize}

	Let us consider our example $\varphi$. We already eliminated $x$ from $\varphi$ and currently, we have $\varphi_{1}$ and $\varphi_{4}$. In both of this formula, there is a constraint $y^{2}-2<0$ from which we already constructed the test candidates $\pm\sqrt{2}+\epsilon$.
	\begin{itemize}
		\item For $t=\sqrt{2}$,
		$$(y^{2}-2<0)[\sqrt{2}+\epsilon\backslash\backslash y]=\underbrace{((y^{2}-2<0)[\sqrt{2}\backslash\backslash y])}\limits_{\text{Case 1}} \text{ }\vee\text{ }\underbrace{((y^{2}-2=0)[\sqrt{2}\backslash\backslash y]\wedge(2y<0)[\sqrt{2}\backslash\backslash x])}\limits_{\text{Case 2}}\text{ }\vee$$
		$$\underbrace{((y^{2}-2=0)[\sqrt{2}\backslash\backslash y]\wedge(2y=0)[\sqrt{2}\backslash\backslash y]\wedge (2<0[\sqrt{2}\backslash\backslash y])}\limits_{\text{Case 3}}\text{ }\wedge \text{ }1\neq 0 \text{ }\wedge \text{ }8 \geq 0 $$
		Here, $y^{2}-2\nless 0$ for $y=\sqrt{2} + \epsilon$. Because, from the figure 1 we can see that for $\sqrt{2}$ case 1 does not hold. If we move to the right of $\sqrt{2}$, the constraint is increasing instead of decreasing. So case 2 and case 3 also do not hold.
		\item For $t=-\sqrt{2}$,
		$$(y^{2}-2<0)[-\sqrt{2}+\epsilon\backslash\backslash y]=\underbrace{((y^{2}-2<0)[-\sqrt{2}\backslash\backslash y])}\limits_{\text{Case 1}} \text{ }\vee\text{ }$$
		
		$$\underbrace{((y^{2}-2=0)[-\sqrt{2}\backslash\backslash y]\wedge(2y<0)[-\sqrt{2}\backslash\backslash x])}\limits_{\text{Case 2}}\text{ }\vee$$
		$$\underbrace{((y^{2}-2=0)[-\sqrt{2}\backslash\backslash y]\wedge(2y=0)[-\sqrt{2}\backslash\backslash y]\wedge (2<0[-\sqrt{2}\backslash\backslash y])}\limits_{\text{Case 3}} \text{ }\wedge\text{ } 1\neq 0 \text{ }\wedge\text{ } 8 \geq 0 $$
		From the figure 1, we can see that case 1 does not hold for $-\sqrt{2}$. But, case 2 holds as the constraint is decreasing for at least one point to right of $-\sqrt{2}$. So, $y^{2}-2<0$ for $y = -\sqrt{2} + \epsilon$
	\end{itemize}
	\begin{center}
	\input{epcilon.tex}
	\end{center}
\subsubsection{Substitution of a Minus Infinity}
	Let $t = -\infty$ is a test candidate of $x$ for $p<0$. $t$ cannot have any other values rather than $-\infty$. If we substitute $x = t$ in $p<0$, then we will get the following formula,
	$$p<0[-\infty\backslash\backslash x] = (a<0) \text{ } \vee \text{ } (a=0 \wedge b>0) \text{ } \vee \text{ } (a=0 \wedge b=0 \wedge c<0) $$
	where, $p=ax^{2}+bx+c$.
	
	In our example, for the constraint $y^{2} - 2 < 0$ of $\varphi_{4}$,
	$$ y^{2} - 2 < 0 [-\infty\backslash\backslash y] = (1<0)\text{ } \vee\text{ } (1=0 \wedge 0 > 0) \text{ } \vee \text{ } (1=0 \ wedge 0=0 \wedge -2<0) $$
	Here, $a=1, b=0$ and $c=-2$.
	\begin{center}
		\input{ro_1.tex}
	\end{center}